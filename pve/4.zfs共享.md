# 共享
## SMB共享
1. 安装 `apt-get install samba`
2. 添加已有用户为samba用户，例如用户root `smbpasswd -a root`
3. 重启 `service smbd restart`
4. 设置zfs的samba共享 `zfs set sharesmb=on pve1zfs2` pve1zfs2是zpool的名字
5. 设置目录权限 `chown -R root:root /pve1zfs2`
6. 临时挂载 `mount -t cifs -o username=root,password=protoss //10.255.0.204/pve1zfs2/subvol-200-disk-0/nasBackup ./tmp`
7. 长期挂载 `vim /etc/fstab`
 `//10.255.0.204/pve1zfs2/subvol-200-disk-0/nasBackup /mnt/share1 cifs defaults,username=root,password=protoss 0 0`

- 查看smb共享用户
`pdbedit -L`

- 可以在/etc/samba/smb.conf末尾中添加
```
#添加一个iso共享库
[iso]                                  //此处是路径，例如//10.13.14.2/iso
   comment = this is a iso             //描述
   path =  /var/lib/vz/template        //共享的文件夹
   guest ok = no                       //不允许访客
   browseable = no                     //不允许浏览
   write list = root                   //运行root读写
```

－懒人可以一键开启
```
cat >>/etc/samba/smb.conf <<EOF
[iso]                                 
   comment = this is a iso           
   path =  /var/lib/vz/template   
   guest ok = no                   
   browseable = no                  
   write list = root 
EOF
```




## ｎｆｓ共享
1、新增硬盘(磁盘阵列)分区

fdisk /dev/sdb

m:显示菜单

g:建立gpt分区，

n:建立partion分区。

w:保存磁盘分区

2、格式化磁盘分区及挂载磁盘

mkfs -t ext4 /dev/sdb1

mount /dev/sdb1 /mnt/sdb(挂载点自定)

永久挂载磁盘：

输入vi /etc/fatab编辑这文件，在最后追加一行 /dev/sdb1 /mnt/sdb ext4 defaults 0 0

保存退出(或者nano /etc/fstab 编辑fstab文件 /dev/sdb1 /mnt/sdb ext4 defaults 0 0 进去最后一行加入 ctrl+x 退出保存 按Y 是否保存 Enter 退出)

3、安装NFS服务端

执行如下命令进行nfs服务端的安装。

apt-get install nfs-common nfs-kernel-server

4、配置共享目录

设置访问目录权限 /data/pve

chmod 777 -R pve1

vi /etc/exports

增加如下内容：

/data/pve1     *(rw,sync,no_root_squash,no_subtree_check,insecure)

启动nfs服务端

/etc/init.d/nfs-kernel-server start

注：如果修改了/etc/exports的内容，执行 exportfs -a  进行更新

5、为NFS制定端口

nano /etc/sysconfig/nfs

将下列端口复制到文件的最下方 并注释

RQUOTAD_PORT=30001

LOCKD_TCPPORT=30002

LOCKD_UDPPORT=30002

MOUNTD_PORT=30003

STATD_PORT=30004

保存文件

6、使用iptables命令添加规则

iptables  -I INPUT -p tcp --dport 111 -j ACCEPT

iptables  -I INPUT -p udp --dport 111 -j ACCEPT

iptables  -I INPUT -p tcp --dport 2049 -j ACCEPT

iptables  -I INPUT -p udp --dport 2049 -j ACCEPT

iptables  -I INPUT -p tcp --dport 30001:30004 -j ACCEPT

iptables  -I INPUT -p udp --dport 30001:30004 -j ACCEPT

service iptables save

service iptables restart

7、PVE对存储进行挂载

然后登入到任意集群节点proxmox web页面操作

依次点击数据中心-存储-添加-NFS

ID随意，服务器输入刚才挂载的IP地址及共享目录(/data/pve1)，内容都选上，点添加

最后点集群节点查看一下是否能识别，就OK了

## zfs去重
1. `zdb -S pvenasZfs2 `查询下,看看有没必要去重.
2. `zfs set dedup=on pvenasZfs2` 开启去重功能
